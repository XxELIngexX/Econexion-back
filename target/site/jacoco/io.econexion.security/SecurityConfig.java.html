<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SecurityConfig.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">econexion-lab</a> &gt; <a href="index.source.html" class="el_package">io.econexion.security</a> &gt; <span class="el_source">SecurityConfig.java</span></div><h1>SecurityConfig.java</h1><pre class="source lang-java linenums">package io.econexion.security;

import com.fasterxml.jackson.databind.ObjectMapper;

import io.econexion.repository.UserRepository;
import io.jsonwebtoken.Jwts;
import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Profile;
import org.springframework.http.HttpMethod;
import org.springframework.http.MediaType;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.authentication.ProviderManager;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.authentication.dao.DaoAuthenticationProvider;
import org.springframework.security.config.Customizer;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.www.BasicAuthenticationFilter;

import java.io.IOException;
import java.util.List;

// &lt;- se activa con el perfil 'lab'
@Configuration
<span class="fc" id="L37">public class SecurityConfig {</span>

    @Bean
    public PasswordEncoder passwordEncoder() {
<span class="fc" id="L41">        return new BCryptPasswordEncoder();</span>
    }

    @Bean
    public UserDetailsService userDetailsService(UserRepository repo) {
<span class="pc" id="L46">        return email -&gt; repo.findByEmail(email)</span>
<span class="nc" id="L47">                .map(user -&gt; org.springframework.security.core.userdetails.User</span>
<span class="nc" id="L48">                        .withUsername(user.getEmail()) // aquí usas el email</span>
<span class="nc" id="L49">                        .password(user.getPassword()) // ya está en BCrypt</span>
                        // .roles(user.getRole() != null ? user.getRole() : &quot;USER&quot;)
<span class="nc" id="L51">                        .build())</span>
<span class="nc" id="L52">                .orElseThrow(() -&gt; new UsernameNotFoundException(&quot;User not found: &quot; + email));</span>
    }

    @Bean
    public JwtUtil jwtUtil(
            @Value(&quot;${jwt.secret}&quot;) String secret,
            @Value(&quot;${jwt.expiration-minutes}&quot;) long expirationMinutes) {
<span class="fc" id="L59">        return new JwtUtil(secret, expirationMinutes);</span>
    }

    @Bean
    public AuthenticationManager authenticationManager(UserDetailsService uds, PasswordEncoder enc) {
<span class="fc" id="L64">        DaoAuthenticationProvider provider = new DaoAuthenticationProvider();</span>
<span class="fc" id="L65">        provider.setUserDetailsService(uds);</span>
<span class="fc" id="L66">        provider.setPasswordEncoder(enc);</span>
<span class="fc" id="L67">        return new ProviderManager(provider);</span>
    }

    @Bean
    public SimpleJwtFilter simpleJwtFilter(JwtUtil jwtUtil, AuthenticationManager am) {
<span class="fc" id="L72">        return new SimpleJwtFilter(jwtUtil, am);</span>
    }

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http, SimpleJwtFilter jwtFilter) throws Exception {
        // Para demo/lab
<span class="fc" id="L78">        http.csrf(csrf -&gt; csrf.disable());</span>

<span class="fc" id="L80">        http.authorizeHttpRequests(auth -&gt; auth</span>
<span class="fc" id="L81">                .requestMatchers(&quot;/api/auth/login&quot;).permitAll()</span>
<span class="fc" id="L82">                .requestMatchers(HttpMethod.GET, &quot;/v1/weather/**&quot;).permitAll()</span>
<span class="fc" id="L83">                .requestMatchers(HttpMethod.POST, &quot;/v1/weather/**&quot;).authenticated()</span>
<span class="fc" id="L84">                .requestMatchers(HttpMethod.GET, &quot;/&quot;).authenticated()</span>
<span class="fc" id="L85">                .anyRequest().permitAll());</span>

        // Necesario para que H2 se renderice en un frame
<span class="fc" id="L88">        http.headers(h -&gt; h.frameOptions(f -&gt; f.sameOrigin()));</span>

<span class="fc" id="L90">        http.addFilterBefore(jwtFilter, BasicAuthenticationFilter.class);</span>
<span class="fc" id="L91">        return http.build();</span>
    }

    // @Bean
    // public LoginController loginController(AuthenticationManager am, JwtUtil jwt,
    // ObjectMapper om) {
    // return new LoginController(am, jwt, om);
    // }

    // ===== soporte =====
    static class SimpleJwtFilter extends BasicAuthenticationFilter {
        private final JwtUtil jwtUtil;

        public SimpleJwtFilter(JwtUtil jwtUtil, AuthenticationManager authenticationManager) {
<span class="fc" id="L105">            super(authenticationManager);</span>
<span class="fc" id="L106">            this.jwtUtil = jwtUtil;</span>
<span class="fc" id="L107">        }</span>

        @Override
        protected void doFilterInternal(HttpServletRequest req, HttpServletResponse res, FilterChain chain)
                throws IOException, ServletException {

<span class="fc" id="L113">            String authHeader = req.getHeader(&quot;Authorization&quot;);</span>

<span class="pc bpc" id="L115" title="3 of 4 branches missed.">            if (authHeader != null &amp;&amp; authHeader.startsWith(&quot;Bearer &quot;)) {</span>
<span class="nc" id="L116">                String token = authHeader.substring(7);</span>

                try {
<span class="nc" id="L119">                    String username = Jwts.parserBuilder()</span>
<span class="nc" id="L120">                            .setSigningKey(jwtUtil.key())</span>
<span class="nc" id="L121">                            .build()</span>
<span class="nc" id="L122">                            .parseClaimsJws(token)</span>
<span class="nc" id="L123">                            .getBody()</span>
<span class="nc" id="L124">                            .getSubject();</span>

<span class="nc" id="L126">                    UsernamePasswordAuthenticationToken authentication = new UsernamePasswordAuthenticationToken(</span>
<span class="nc" id="L127">                            username, null, List.of());</span>

<span class="nc" id="L129">                    SecurityContextHolder.getContext().setAuthentication(authentication);</span>

<span class="nc" id="L131">                } catch (Exception e) {</span>
<span class="nc" id="L132">                    res.sendError(HttpServletResponse.SC_UNAUTHORIZED, &quot;Invalid token&quot;);</span>
<span class="nc" id="L133">                    return;</span>
<span class="nc" id="L134">                }</span>
            }
<span class="fc" id="L136">            chain.doFilter(req, res);</span>
<span class="fc" id="L137">        }</span>
    }

<span class="nc" id="L140">    public record LoginRequest(String email, String password) {</span>
    }

<span class="nc" id="L143">    public record LoginResponse(String token) {</span>
    }

    public static class LoginController {
        private final AuthenticationManager am;
        private final JwtUtil jwt;
        private final ObjectMapper om;

<span class="nc" id="L151">        public LoginController(AuthenticationManager am, JwtUtil jwt, ObjectMapper om) {</span>
<span class="nc" id="L152">            this.am = am;</span>
<span class="nc" id="L153">            this.jwt = jwt;</span>
<span class="nc" id="L154">            this.om = om;</span>
<span class="nc" id="L155">        }</span>

        @org.springframework.web.bind.annotation.PostMapping(value = &quot;/api/auth/login&quot;, consumes = MediaType.APPLICATION_JSON_VALUE, produces = MediaType.APPLICATION_JSON_VALUE)
        public void login(HttpServletRequest req, HttpServletResponse res) throws IOException {
<span class="nc" id="L159">            LoginRequest body = om.readValue(req.getInputStream(), LoginRequest.class);</span>
<span class="nc" id="L160">            Authentication auth = am.authenticate(</span>
<span class="nc" id="L161">                    new UsernamePasswordAuthenticationToken(body.email(), body.password()));</span>
<span class="nc" id="L162">            String token = jwt.generate(auth.getName());</span>
<span class="nc" id="L163">            res.setContentType(MediaType.APPLICATION_JSON_VALUE);</span>
<span class="nc" id="L164">            om.writeValue(res.getOutputStream(), new LoginResponse(token));</span>
<span class="nc" id="L165">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>